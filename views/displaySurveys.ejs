<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Take a Survey</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&display=swap" rel="stylesheet">
	<style>
		:root {
			--cream: #f9f5ea;
			--light-pink: #ffd8d1;
			--pink: #f9afb1;
			--gray: #3a3f3b;
		}

		body { background-color: var(--light-pink); font-family: Arial, sans-serif; margin:0; color:var(--gray); min-height:100vh; display:flex; flex-direction:column; }

		.navbar-brand { font-weight: bold; display:flex; align-items:center; gap:6px; font-size:1.25rem; }

		.btn-white { background: white; border: 2px solid var(--gray); color: var(--gray) !important; transition: 0.2s; }
		.btn-white:hover { background: var(--gray); color: white !important; }

		.card { border-radius: 12px; }
		.survey-header { font-family: 'DM Serif Display', serif; font-size: 1.6rem; }
		.survey-form { margin-top: 12px; }
		.event-group { margin-bottom: 20px; }
		.event-header { cursor: pointer; padding: 12px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #e45858; }
		.event-header:hover { background: #e9ecef; }
		.event-content { padding: 12px; background: #ffffff; border: 1px solid #dee2e6; border-top: none; border-radius: 0 0 8px 8px; }
		.label { font-weight: 600; color: #444; }

		.page-wrapper { padding: 40px 20px; flex: 1; }

		/* FOOTER */
		.footer { background-color: black; color: white; height: 100px; display:flex; justify-content:center; align-items:center; margin-top:auto; width:100vw; position:relative; left:50%; right:50%; margin-left:-50vw; margin-right:-50vw; }
		.footer-text { font-family: 'DM Serif Display', serif; font-size:1.5rem; display:flex; gap:10px; align-items:center; }
		.copyright { text-align:center; padding:8px 0 20px; font-size:0.9rem; }
	</style>
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar navbar-light bg-white shadow-sm px-4">
  <a class="navbar-brand" href="/">
    Ella
    <img src="/fulllogo.jpg" alt="Ella Rises Logo" style="width:35px; height:35px; object-fit: contain; vertical-align: text-bottom; margin-left: 8px;">
    Rises
  </a>

  <div>
    <a href="/userDashboard" class="btn btn-white btn-sm me-2">Back to Dashboard</a>
    <a href="/logout" class="btn btn-white btn-sm">Logout</a>
  </div>
</nav>

<!-- PAGE -->
<div class="page-wrapper container">
	<div class="row justify-content-center">
		<div class="col-md-10">
			<div class="card p-4">
				<div class="d-flex justify-content-between align-items-center">
				<div>
					<h2 class="survey-header">Event Surveys</h2>
				</div>
					</div>

					<% if (typeof survey !== 'undefined' && survey && survey.SurveyID) { %>
						<hr />
						<div class="d-flex justify-content-between align-items-center mb-4">
							<h3>Survey Detail</h3>
							<a href="/displaySurveys" class="btn btn-white btn-sm">Back</a>
						</div>
						
						<!-- View Mode -->
						<div id="viewMode">
							<div class="card p-4 mb-4">
							<h5>Survey ID: <%= survey.SurveyID %></h5>
							<div class="row mt-4">
								<div class="col-md-6">
									<p><span class="label">Event:</span> <%= survey.EventName || '—' %></p>
									<p><span class="label">Event Date:</span> <%= survey.EventDateTimeStart ? new Date(survey.EventDateTimeStart).toLocaleString() : '—' %></p>
									<p><span class="label">Participant Name:</span> <%= (survey.ParticipantFirstName || '') + ' ' + (survey.ParticipantLastName || '') %></p>
									<p><span class="label">Email:</span> <%= survey.ParticipantEmail || '—' %></p>
									<p><span class="label">Phone:</span> <%= survey.ParticipantPhone || '—' %></p>
								</div>
								<div class="col-md-6">
									<p><span class="label">Submitted:</span> <%= survey.SurveySubmissionDate ? new Date(survey.SurveySubmissionDate).toLocaleString() : '—' %></p>
									<p><span class="label">Overall Score:</span> <%= (survey.SurveyOverallScore !== null && !isNaN(parseFloat(survey.SurveyOverallScore))) ? parseFloat(survey.SurveyOverallScore).toFixed(2) : '—' %></p>
									<p><span class="label">NPS Bucket:</span> <%= survey.SurveyNPSBucket || '—' %></p>
								</div>
							</div>
							<hr />
							<h5>Scores</h5>
							<div class="row mt-3">
								<div class="col-md-3">
									<p><span class="label">Satisfaction:</span> <%= survey.SurveySatisfactionScore !== null ? survey.SurveySatisfactionScore : '—' %></p>
								</div>
								<div class="col-md-3">
									<p><span class="label">Usefulness:</span> <%= survey.SurveyUsefulnessScore !== null ? survey.SurveyUsefulnessScore : '—' %></p>
								</div>
								<div class="col-md-3">
									<p><span class="label">Instructor:</span> <%= survey.SurveyInstructorScore !== null ? survey.SurveyInstructorScore : '—' %></p>
								</div>
								<div class="col-md-3">
									<p><span class="label">Recommend:</span> <%= survey.SurveyRecommendationScore !== null ? survey.SurveyRecommendationScore : '—' %></p>
								</div>
							</div>
							<hr />
							<h5>Comments</h5>
							<p><%= survey.SurveyComments || '<em class="text-muted">No comments provided.</em>' %></p>
							<hr />
							<% if (typeof userLevel !== 'undefined' && userLevel === 'M') { %>
								<div class="mt-3">
									<button onclick="toggleEditMode()" class="btn btn-primary me-2">Edit Survey</button>
									<form method="POST" action="/deleteSurvey" style="display: inline;" onsubmit="return confirm('Delete this survey?');">
										<input type="hidden" name="surveyId" value="<%= survey.SurveyID %>" />
										<button type="submit" class="btn btn-danger">Delete Survey</button>
									</form>
								</div>
							<% } %>
							</div>
						</div>

						<!-- Edit Mode -->
						<% if (typeof userLevel !== 'undefined' && userLevel === 'M') { %>
							<div id="editMode" style="display: none;">
								<div class="card p-4 mb-4">
									<h5>Edit Survey</h5>
									<form method="POST" action="/updateSurvey">
										<input type="hidden" name="surveyId" value="<%= survey.SurveyID %>" />
										<div class="row mt-3">
											<div class="col-md-3">
												<div class="mb-3">
													<label class="form-label">Satisfaction (1-5)</label>
													<select name="satisfaction" class="form-select">
														<option value="">--</option>
														<option value="1" <%= survey.SurveySatisfactionScore === 1 ? 'selected' : '' %>>1</option>
														<option value="2" <%= survey.SurveySatisfactionScore === 2 ? 'selected' : '' %>>2</option>
														<option value="3" <%= survey.SurveySatisfactionScore === 3 ? 'selected' : '' %>>3</option>
														<option value="4" <%= survey.SurveySatisfactionScore === 4 ? 'selected' : '' %>>4</option>
														<option value="5" <%= survey.SurveySatisfactionScore === 5 ? 'selected' : '' %>>5</option>
													</select>
												</div>
											</div>
											<div class="col-md-3">
												<div class="mb-3">
													<label class="form-label">Usefulness (1-5)</label>
													<select name="usefulness" class="form-select">
														<option value="">--</option>
														<option value="1" <%= survey.SurveyUsefulnessScore === 1 ? 'selected' : '' %>>1</option>
														<option value="2" <%= survey.SurveyUsefulnessScore === 2 ? 'selected' : '' %>>2</option>
														<option value="3" <%= survey.SurveyUsefulnessScore === 3 ? 'selected' : '' %>>3</option>
														<option value="4" <%= survey.SurveyUsefulnessScore === 4 ? 'selected' : '' %>>4</option>
														<option value="5" <%= survey.SurveyUsefulnessScore === 5 ? 'selected' : '' %>>5</option>
													</select>
												</div>
											</div>
											<div class="col-md-3">
												<div class="mb-3">
													<label class="form-label">Instructor (1-5)</label>
													<select name="instructor" class="form-select">
														<option value="">--</option>
														<option value="1" <%= survey.SurveyInstructorScore === 1 ? 'selected' : '' %>>1</option>
														<option value="2" <%= survey.SurveyInstructorScore === 2 ? 'selected' : '' %>>2</option>
														<option value="3" <%= survey.SurveyInstructorScore === 3 ? 'selected' : '' %>>3</option>
														<option value="4" <%= survey.SurveyInstructorScore === 4 ? 'selected' : '' %>>4</option>
														<option value="5" <%= survey.SurveyInstructorScore === 5 ? 'selected' : '' %>>5</option>
													</select>
												</div>
											</div>
											<div class="col-md-3">
												<div class="mb-3">
													<label class="form-label">Recommend (1-5)</label>
													<select name="recommend" class="form-select">
														<option value="">--</option>
														<option value="1" <%= survey.SurveyRecommendationScore === 1 ? 'selected' : '' %>>1</option>
														<option value="2" <%= survey.SurveyRecommendationScore === 2 ? 'selected' : '' %>>2</option>
														<option value="3" <%= survey.SurveyRecommendationScore === 3 ? 'selected' : '' %>>3</option>
														<option value="4" <%= survey.SurveyRecommendationScore === 4 ? 'selected' : '' %>>4</option>
														<option value="5" <%= survey.SurveyRecommendationScore === 5 ? 'selected' : '' %>>5</option>
													</select>
												</div>
											</div>
										</div>
										<div class="mb-3">
											<label class="form-label">Comments</label>
											<textarea name="comments" class="form-control" rows="3"><%= survey.SurveyComments || '' %></textarea>
										</div>
										<div class="mt-3">
											<button type="submit" class="btn btn-success me-2">Save Changes</button>
											<button type="button" onclick="toggleEditMode()" class="btn btn-secondary">Cancel</button>
										</div>
									</form>
								</div>
							</div>
						<% } %>
					<% } else if (typeof groupedSurveys !== 'undefined' && groupedSurveys && Object.keys(groupedSurveys).length > 0) { %>
						<hr />
						<h4>All Survey Submissions by Event</h4>
						
						<!-- Add New Survey -->
						<% if (typeof userLevel !== 'undefined' && userLevel === 'M') { %>
							<div class="mb-3">
								<button class="btn btn-success" data-bs-toggle="collapse" data-bs-target="#addSurveyForm" aria-expanded="false">
									<i class="bi bi-plus-circle"></i> Add New Survey
								</button>
							</div>
							<div class="collapse mb-3" id="addSurveyForm">
								<div class="card p-3">
									<h5>New Survey</h5>
									<form method="POST" action="/createSurvey">
										<div class="row">
											<div class="col-md-6">
												<div class="mb-3">
													<label class="form-label">Participant *</label>
													<select name="participantId" id="participantSelect" class="form-select" required>
														<option value="">-- Select Participant --</option>
														<% if (typeof participants !== 'undefined') { %>
															<% participants.forEach(function(p) { %>
																<option value="<%= p.participantid || p.ParticipantID %>">
																	<%= (p.participantfirstname || p.ParticipantFirstName || '') + ' ' + (p.participantlastname || p.ParticipantLastName || '') %>
																</option>
															<% }) %>
														<% } %>
													</select>
												</div>
											</div>
											<div class="col-md-6">
												<div class="mb-3">
													<label class="form-label">Event *</label>
													<select name="eventId" id="eventSelect" class="form-select" required disabled>
														<option value="">-- Select Participant First --</option>
													</select>
												</div>
											</div>
										</div>
										<input type="hidden" name="registrationId" id="registrationId" value="">
										<div class="row">
											<div class="col-md-3">
												<div class="mb-3">
													<label class="form-label">Satisfaction (1-5)</label>
													<select name="satisfaction" class="form-select">
														<option value="">--</option>
														<option value="1">1</option>
														<option value="2">2</option>
														<option value="3">3</option>
														<option value="4">4</option>
														<option value="5">5</option>
													</select>
												</div>
											</div>
											<div class="col-md-3">
												<div class="mb-3">
													<label class="form-label">Usefulness (1-5)</label>
													<select name="usefulness" class="form-select">
														<option value="">--</option>
														<option value="1">1</option>
														<option value="2">2</option>
														<option value="3">3</option>
														<option value="4">4</option>
														<option value="5">5</option>
													</select>
												</div>
											</div>
											<div class="col-md-3">
												<div class="mb-3">
													<label class="form-label">Instructor (1-5)</label>
													<select name="instructor" class="form-select">
														<option value="">--</option>
														<option value="1">1</option>
														<option value="2">2</option>
														<option value="3">3</option>
														<option value="4">4</option>
														<option value="5">5</option>
													</select>
												</div>
											</div>
											<div class="col-md-3">
												<div class="mb-3">
													<label class="form-label">Recommend (1-5)</label>
													<select name="recommend" class="form-select">
														<option value="">--</option>
														<option value="1">1</option>
														<option value="2">2</option>
														<option value="3">3</option>
														<option value="4">4</option>
														<option value="5">5</option>
													</select>
												</div>
											</div>
										</div>
										<div class="mb-3">
											<label class="form-label">Comments</label>
											<textarea name="comments" class="form-control" rows="3" placeholder="Share feedback..."></textarea>
										</div>
										<div class="mt-3">
											<button type="submit" class="btn btn-primary">Create Survey</button>
											<button type="button" class="btn btn-secondary" data-bs-toggle="collapse" data-bs-target="#addSurveyForm">Cancel</button>
										</div>
									</form>
								</div>
							</div>

							<script>
								// Embed registrations data from backend
								const registrationsData = <%- JSON.stringify(typeof registrations !== 'undefined' ? registrations : []) %>;
								
								document.getElementById('participantSelect').addEventListener('change', function() {
									const participantId = parseInt(this.value, 10);
									const eventSelect = document.getElementById('eventSelect');
									
									// Clear event dropdown
									eventSelect.innerHTML = '<option value="">-- Select Event --</option>';
									
									if (!participantId) {
										eventSelect.disabled = true;
										return;
									}
									
									// Find all events for this participant
									const participantRegistrations = registrationsData.filter(r => {
										const regParticipantId = parseInt(r.participantid || r.ParticipantID, 10);
										return regParticipantId === participantId;
									});
									
									if (participantRegistrations.length === 0) {
										eventSelect.innerHTML = '<option value="">No events for this participant</option>';
										eventSelect.disabled = true;
										return;
									}
									
									// Populate event dropdown with unique events
									const uniqueEvents = {};
									participantRegistrations.forEach(reg => {
										const eventId = reg.eventoccurrenceid || reg.EventOccurrenceID;
										const eventName = reg.eventname || reg.EventName || 'Unknown Event';
										if (eventId && !uniqueEvents[eventId]) {
											uniqueEvents[eventId] = eventName;
										}
									});
									
									Object.entries(uniqueEvents).forEach(([eventId, eventName]) => {
										const option = document.createElement('option');
										option.value = eventId;
										option.textContent = eventName;
										eventSelect.appendChild(option);
									});
									
									eventSelect.disabled = false;
								});
							</script>
						<% } %>

						<!-- Search Bar -->
						<div class="mb-3">
							<input type="text" id="searchInput" class="form-control" placeholder="Search by participant name..." onkeyup="filterSurveys()">
						</div>

						<% Object.entries(groupedSurveys).forEach(function([eventName, surveysForEvent]) { %>
							<% if (surveysForEvent.length > 0) { %>
								<div class="event-group">
									<div class="event-header" data-bs-toggle="collapse" data-bs-target="#event-<%= eventName.replace(/\s+/g, '-').toLowerCase() %>" aria-expanded="false">
										<strong><%= eventName %></strong>
										<span class="float-end badge bg-secondary"><%= surveysForEvent.length %> surveys</span>
									</div>
									<div class="collapse" id="event-<%= eventName.replace(/\s+/g, '-').toLowerCase() %>">
										<div class="event-content">
											<div class="table-responsive">
												<table class="table table-sm table-striped mb-0">
													<thead class="table-dark">
														<tr>
															<th>Participant</th>
															<th>Satisfaction</th>
															<th>Usefulness</th>
															<th>Instructor</th>
															<th>Recommend</th>
															<th>Overall</th>
															<th>NPS</th>
															<th>Submitted</th>
														</tr>
													</thead>
													<tbody>
														<% surveysForEvent.forEach(function(s) { %>
															<tr class="survey-row" data-name="<%= ((s.ParticipantFirstName || '') + ' ' + (s.ParticipantLastName || '')).toLowerCase() %>" onclick="window.location.href='/displaySurveys?id=<%= s.SurveyID %>';" style="cursor: pointer;">
																<td><%= (s.ParticipantFirstName || '') + ' ' + (s.ParticipantLastName || '') %><br/><small class="text-muted"><%= s.ParticipantEmail || '—' %></small></td>
																<td><%= s.SurveySatisfactionScore !== null ? s.SurveySatisfactionScore : '—' %></td>
																<td><%= s.SurveyUsefulnessScore !== null ? s.SurveyUsefulnessScore : '—' %></td>
																<td><%= s.SurveyInstructorScore !== null ? s.SurveyInstructorScore : '—' %></td>
																<td><%= s.SurveyRecommendationScore !== null ? s.SurveyRecommendationScore : '—' %></td>
																<td><%= (s.SurveyOverallScore !== null && s.SurveyOverallScore !== undefined && !isNaN(parseFloat(s.SurveyOverallScore))) ? parseFloat(s.SurveyOverallScore).toFixed(2) : '—' %></td>
																<td><%= s.SurveyNPSBucket || '—' %></td>
																<td><%= s.SurveySubmissionDate ? new Date(s.SurveySubmissionDate).toLocaleDateString() : '—' %></td>
															</tr>
														<% }) %>
													</tbody>
												</table>
											</div>
										</div>
									</div>
								</div>
							<% } %>
						<% }) %>
					<% } %>

					<% if (typeof userLevel === 'undefined' || userLevel !== 'M') { %>
						<% if (typeof registrations === 'undefined' || !registrations || registrations.length === 0) { %>
							<div class="alert alert-info mt-3">No registered events found. Register for an event to submit a survey.</div>
						<% } %>

						<% if (typeof registrations !== 'undefined' && registrations && registrations.length > 0) { %>
							<% registrations.forEach(function(reg) { %>
								<div class="border rounded p-3 mb-3">
									<h5><%= reg.EventName %></h5>
									<small class="text-muted">Date: <%= reg.EventDateTimeStart ? new Date(reg.EventDateTimeStart).toLocaleString() : '—' %></small>

									<form class="survey-form" method="POST" action="/submitSurvey">
										<input type="hidden" name="registrationId" value="<%= reg.RegistrationID %>" />

										<div class="row g-2 mt-3">
											<div class="col-md-3">
												<label class="form-label">Satisfaction (1-5)</label>
												<select name="satisfaction" class="form-select">
													<option value="">--</option>
													<option value="1">1</option>
													<option value="2">2</option>
													<option value="3">3</option>
													<option value="4">4</option>
													<option value="5">5</option>
												</select>
											</div>
											<div class="col-md-3">
												<label class="form-label">Usefulness (1-5)</label>
												<select name="usefulness" class="form-select">
													<option value="">--</option>
													<option value="1">1</option>
													<option value="2">2</option>
													<option value="3">3</option>
													<option value="4">4</option>
													<option value="5">5</option>
												</select>
											</div>
											<div class="col-md-3">
												<label class="form-label">Instructor (1-5)</label>
												<select name="instructor" class="form-select">
													<option value="">--</option>
													<option value="1">1</option>
													<option value="2">2</option>
													<option value="3">3</option>
													<option value="4">4</option>
													<option value="5">5</option>
												</select>
											</div>
											<div class="col-md-3">
												<label class="form-label">Recommend (1-5)</label>
												<select name="recommend" class="form-select">
													<option value="">--</option>
													<option value="1">1</option>
													<option value="2">2</option>
													<option value="3">3</option>
													<option value="4">4</option>
													<option value="5">5</option>
												</select>
											</div>
										</div>

										<div class="mb-3 mt-3">
											<label class="form-label">Comments</label>
											<textarea name="comments" class="form-control" rows="3" placeholder="Share feedback..."></textarea>
										</div>

										<div class="d-flex justify-content-end">
											<button type="submit" class="btn btn-primary">Submit Survey</button>
										</div>
									</form>
								</div>
							<% }); %>
						<% } %>
					<% } %>

				</div>
			</div>
		</div>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
	<script>
		function toggleEditMode() {
			const viewMode = document.getElementById('viewMode');
			const editMode = document.getElementById('editMode');
			if (viewMode.style.display === 'none') {
				viewMode.style.display = 'block';
				editMode.style.display = 'none';
			} else {
				viewMode.style.display = 'none';
				editMode.style.display = 'block';
			}
		}

		function filterSurveys() {
			const input = document.getElementById('searchInput');
			const filter = input.value.toLowerCase();
			const rows = document.getElementsByClassName('survey-row');
			const eventGroups = document.getElementsByClassName('event-group');
			
			// Filter rows
			for (let i = 0; i < rows.length; i++) {
				const name = rows[i].getAttribute('data-name');
				if (name.indexOf(filter) > -1) {
					rows[i].style.display = '';
				} else {
					rows[i].style.display = 'none';
				}
			}
			
			// Show/hide event groups and auto-expand if searching
			for (let i = 0; i < eventGroups.length; i++) {
				const eventGroup = eventGroups[i];
				const visibleRows = Array.from(eventGroup.querySelectorAll('.survey-row')).filter(row => row.style.display !== 'none');
				
				if (visibleRows.length > 0) {
					eventGroup.style.display = '';
					const collapseDiv = eventGroup.querySelector('.collapse');
					
					if (filter.length > 0) {
						// Auto-expand groups when searching
						if (collapseDiv && !collapseDiv.classList.contains('show')) {
							const bsCollapse = new bootstrap.Collapse(collapseDiv, { toggle: true });
						}
					} else {
						// Collapse groups when search is cleared
						if (collapseDiv && collapseDiv.classList.contains('show')) {
							const bsCollapse = new bootstrap.Collapse(collapseDiv, { toggle: true });
						}
					}
				} else {
					eventGroup.style.display = 'none';
				}
			}
		}
	</script>

<!-- FOOTER -->
<div class="footer">
  <div class="footer-text">
    Ella 
    <img src="/EllaRises.jpg" alt="Logo" style="width:30px; height:auto; vertical-align: middle;">
    Rises
  </div>
</div>

<p class="copyright">© 2025 Ella Rises. All Rights Reserved.</p>

</body>
</html>
