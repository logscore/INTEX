<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Events</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&display=swap" rel="stylesheet">
  <style>
    :root { --cream:#f9f5ea; --light-pink:#ffd8d1; --pink:#f9afb1; --gray:#3a3f3b; }
    body { background-color:var(--light-pink); font-family:Arial, sans-serif; margin:0; color:var(--gray); min-height:100vh; display:flex; flex-direction:column; }
    .navbar-brand{ font-weight:bold; display:flex; align-items:center; gap:6px; font-size:1.25rem; }
    .btn-white{ background:white; border:2px solid var(--gray); color:var(--gray)!important; transition:0.2s }
    .btn-white:hover{ background:var(--gray); color:white!important }
    .card{ border-radius:12px }
    .label{ font-weight:600; color:#444 }
    .event-group { margin-bottom: 20px; }
    .event-header { cursor: pointer; padding: 12px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #e45858; }
    .event-header:hover { background: #e9ecef; }
    .event-content { padding: 12px; background: #ffffff; border: 1px solid #dee2e6; border-top: none; border-radius: 0 0 8px 8px; }
    .event-row { cursor: pointer; }
    .event-row:hover { background-color: #f5f5f5; }
    .page-wrapper{ padding:40px 20px; flex:1 }
    .footer{ background-color:black; color:white; height:100px; display:flex; justify-content:center; align-items:center; margin-top:auto; width:100vw; position:relative; left:50%; right:50%; margin-left:-50vw; margin-right:-50vw; }
    .footer-text{ font-family:'DM Serif Display', serif; font-size:1.5rem; display:flex; gap:10px; align-items:center }
    .copyright{ text-align:center; padding:8px 0 20px; font-size:0.9rem }
  </style>
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar navbar-light bg-white shadow-sm px-4">
  <a class="navbar-brand" href="/">
    Ella
    <img src="/fulllogo.jpg" alt="Ella Rises Logo" style="width:35px; height:35px; object-fit: contain; vertical-align: text-bottom; margin-left: 8px;">
    Rises
  </a>

  <div>
    <a href="/userDashboard" class="btn btn-white btn-sm me-2">Back to Dashboard</a>
    <a href="/logout" class="btn btn-white btn-sm">Logout</a>
  </div>
</nav>

<div class="page-wrapper container">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <div class="card p-4 mb-4">
        <h2>Events</h2>

        <!-- EVENT LIST VIEW -->
        <% if (typeof groupedEvents !== 'undefined' && groupedEvents && Object.keys(groupedEvents).length > 0) { %>
          <div class="card p-3 mb-4">
            <h4>All Events</h4>
            
            
            <!-- Add New Event -->
            <% if (typeof userLevel !== 'undefined' && userLevel === 'M') { %>
              <div class="mb-3">
                <a href="/addEvent" class="btn btn-success">+ Add New Event</a>
              </div>
            <% } %>

            <!-- Search Bar -->
            <div class="mb-3">
              <input type="text" id="searchInput" class="form-control" placeholder="Search by event name..." onkeyup="filterEvents()">
            </div>            <!-- Events grouped by type -->
            <% Object.entries(groupedEvents).forEach(function([eventType, typeEvents]) { %>
              <% if (typeEvents.length > 0) { %>
                <div class="event-group">
                  <div class="event-header" data-bs-toggle="collapse" data-bs-target="#type-<%= eventType.replace(/\s+/g, '-').toLowerCase() %>" aria-expanded="false">
                    <strong><%= eventType %></strong>
                    <span class="float-end badge bg-secondary"><%= typeEvents.length %> event<%= typeEvents.length !== 1 ? 's' : '' %></span>
                  </div>
                  <div class="collapse" id="type-<%= eventType.replace(/\s+/g, '-').toLowerCase() %>">
                    <div class="event-content">
                      <div class="table-responsive">
                        <table class="table table-sm table-striped mb-0">
                          <thead class="table-dark">
                            <tr>
                              <th>Name</th>
                              <th>Location</th>
                              <th>Start Date</th>
                              <th>End Date</th>
                              <th>Capacity</th>
                              <th>Registration Deadline</th>
                            </tr>
                          </thead>
                          <tbody>
                            <% typeEvents.forEach(function(e) { %>
                              <tr class="event-row" data-name="<%= (e.EventName || '').toLowerCase() %>" onclick="window.location.href='/displayEvents?id=<%= e.EventOccurrenceID %>';" style="cursor: pointer;">
                                <td><%= e.EventName %></td>
                                <td><%= e.EventLocation || '—' %></td>
                                <td><%= e.EventDateTimeStart ? new Date(e.EventDateTimeStart).toLocaleDateString() : '—' %></td>
                                <td><%= e.EventDateTimeEnd ? new Date(e.EventDateTimeEnd).toLocaleDateString() : '—' %></td>
                                <td><%= e.EventCapacity || '—' %></td>
                                <td><%= e.EventRegistrationDeadline ? new Date(e.EventRegistrationDeadline).toLocaleDateString() : '—' %></td>
                              </tr>
                            <% }); %>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
              <% } %>
            <% }); %>
          </div>

        <!-- EVENT DETAIL VIEW -->
        <% } else if (typeof event !== 'undefined' && event && event.EventOccurrenceID) { %>
          <div class="card p-4 mb-4">
            <h4><%= event.EventName %> <small class="text-muted">(ID: <%= event.EventOccurrenceID %>)</small></h4>
            
            <div class="row mt-3">
              <div class="col-md-6">
                <p><span class="label">Type:</span> <%= event.EventType || '—' %></p>
                <p><span class="label">Location:</span> <%= event.EventLocation || '—' %></p>
                <p><span class="label">Capacity:</span> <%= event.EventCapacity || '—' %></p>
              </div>
              <div class="col-md-6">
                <p><span class="label">Start Date/Time:</span> <%= event.EventDateTimeStart ? new Date(event.EventDateTimeStart).toLocaleString() : '—' %></p>
                <p><span class="label">End Date/Time:</span> <%= event.EventDateTimeEnd ? new Date(event.EventDateTimeEnd).toLocaleString() : '—' %></p>
                <p><span class="label">Registration Deadline:</span> <%= event.EventRegistrationDeadline ? new Date(event.EventRegistrationDeadline).toLocaleDateString() : '—' %></p>
              </div>
            </div>
            
            <hr />
            
            <p><span class="label">Description:</span></p>
            <p><%= event.EventDescription || '—' %></p>
            
            <% if (typeof userLevel !== 'undefined' && userLevel === 'M') { %>
              <div class="mt-3">
                <a href="/editEvent?id=<%= event.EventOccurrenceID %>" class="btn btn-primary me-2">Edit Event</a>
                <button onclick="confirmDeleteEvent(<%= event.EventOccurrenceID %>)" class="btn btn-danger">Delete Event</button>
                <a href="/displayEvents" class="btn btn-secondary">Back to List</a>
              </div>
            <% } else { %>
              <div class="mt-3">
                <a href="/displayEvents" class="btn btn-secondary">Back to List</a>
              </div>
            <% } %>
          </div>

        <% } else { %>
          <div class="card p-4 mb-4">
            <p>No events available at this time.</p>
            <% if (typeof userLevel !== 'undefined' && userLevel === 'M') { %>
              <a href="/addEvent" class="btn btn-success">+ Add New Event</a>
            <% } %>
          </div>
        <% } %>
      </div>
    </div>
  </div>
</div>

<!-- FOOTER -->
<div class="footer">
  <div class="footer-text">
    Ella
    <img src="/fulllogo.jpg" alt="Ella Rises Logo" style="width:40px; height:40px; object-fit: contain;">
    Rises
  </div>
</div>

<p class="copyright">&copy; 2025 Ella Rises. All rights reserved.</p>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  function filterEvents() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const eventRows = document.querySelectorAll('.event-row');
    const eventGroups = document.querySelectorAll('.event-group');
    
    eventRows.forEach(row => {
      const eventName = row.textContent.toLowerCase();
      if (eventName.includes(searchTerm)) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });

    // Show/hide event groups and auto-expand/collapse based on search
    eventGroups.forEach(group => {
      const visibleRows = Array.from(group.querySelectorAll('.event-row')).filter(row => row.style.display !== 'none');
      
      if (visibleRows.length > 0) {
        group.style.display = '';
        const collapseDiv = group.querySelector('.collapse');
        
        if (searchTerm.length > 0) {
          // Auto-expand groups when searching
          if (collapseDiv && !collapseDiv.classList.contains('show')) {
            const bsCollapse = new bootstrap.Collapse(collapseDiv, { toggle: true });
          }
        } else {
          // Collapse groups when search is cleared
          if (collapseDiv && collapseDiv.classList.contains('show')) {
            const bsCollapse = new bootstrap.Collapse(collapseDiv, { toggle: true });
          }
        }
      } else {
        group.style.display = 'none';
      }
    });
  }

  function confirmDeleteEvent(eventId) {
    if (confirm('Are you sure you want to delete this event?')) {
      fetch('/deleteEvent', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ eventId: eventId })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert('Event deleted successfully');
          window.location.href = '/displayEvents';
        } else {
          alert('Error deleting event: ' + (data.message || 'Unknown error'));
        }
      })
      .catch(err => {
        console.error('Error:', err);
        alert('Error deleting event');
      });
    }
  }
</script>

</body>
</html>
