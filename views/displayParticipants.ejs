<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Participants</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #ffd8d1; font-family: Arial, sans-serif; padding-top: 90px; }
    .card { border-radius: 12px; }
    .label { font-weight: 600; color: #444; }
    .city-group { margin-bottom: 20px; }
    .city-header { cursor: pointer; padding: 12px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #e45858; }
    .city-header:hover { background: #e9ecef; }
    .city-content { padding: 12px; background: #ffffff; border: 1px solid #dee2e6; border-top: none; border-radius: 0 0 8px 8px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-10">
        <div class="card p-4 mb-4">
          <div class="d-flex justify-content-between align-items-center">
            <h2>Participants</h2>
            <% if (typeof groupedParticipants !== 'undefined' && groupedParticipants) { %>
              <a href="/userDashboard" class="btn btn-white btn-sm">Return to Dashboard</a>
            <% } else if (typeof participant !== 'undefined' && participant && participant.ParticipantID) { %>
              <a href="/displayParticipants" class="btn btn-white btn-sm">Back</a>
            <% } %>
          </div>
        </div>

        <% if (typeof groupedParticipants !== 'undefined' && groupedParticipants) { %>
          <div class="card p-3 mb-4">
            <h4>All Participants</h4>
            
            <!-- Add New Participant -->
            <% if (typeof userLevel !== 'undefined' && userLevel === 'M') { %>
              <div class="mb-3">
                <button class="btn btn-success" data-bs-toggle="collapse" data-bs-target="#addParticipantForm" aria-expanded="false">
                  <i class="bi bi-plus-circle"></i> Add New Participant
                </button>
              </div>
              <div class="collapse mb-3" id="addParticipantForm">
                <div class="card p-3">
                  <h5>New Participant</h5>
                  <form method="POST" action="/createParticipant">
                    <div class="row">
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label class="form-label">First Name *</label>
                          <input type="text" name="firstName" class="form-control" required />
                        </div>
                        <div class="mb-3">
                          <label class="form-label">Last Name *</label>
                          <input type="text" name="lastName" class="form-control" required />
                        </div>
                        <div class="mb-3">
                          <label class="form-label">Email *</label>
                          <input type="email" name="email" class="form-control" required />
                        </div>
                        <div class="mb-3">
                          <label class="form-label">Phone</label>
                          <input type="text" name="phone" class="form-control" />
                        </div>
                        <div class="mb-3">
                          <label class="form-label">Date of Birth</label>
                          <input type="date" name="dob" class="form-control" />
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label class="form-label">Role</label>
                          <input type="text" name="role" class="form-control" />
                        </div>
                        <div class="mb-3">
                          <label class="form-label">City</label>
                          <input type="text" name="city" class="form-control" />
                        </div>
                        <div class="mb-3">
                          <label class="form-label">State</label>
                          <input type="text" name="state" class="form-control" />
                        </div>
                        <div class="mb-3">
                          <label class="form-label">Zip Code</label>
                          <input type="text" name="zip" class="form-control" />
                        </div>
                      </div>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">School / Employer</label>
                      <input type="text" name="schoolOrEmployer" class="form-control" />
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Field of Interest</label>
                      <input type="text" name="fieldOfInterest" class="form-control" />
                    </div>
                    <div class="mt-3">
                      <button type="submit" class="btn btn-primary">Create Participant</button>
                      <button type="button" class="btn btn-secondary" data-bs-toggle="collapse" data-bs-target="#addParticipantForm">Cancel</button>
                    </div>
                  </form>
                </div>
              </div>
            <% } %>

            <div class="mb-3">
              <input type="text" id="searchInput" class="form-control" placeholder="Search by participant name..." onkeyup="filterParticipants()">
            </div>
            <% Object.entries(groupedParticipants).forEach(function([city, cityParticipants]) { %>
              <% if (cityParticipants.length > 0) { %>
                <div class="city-group">
                  <div class="city-header" data-bs-toggle="collapse" data-bs-target="#city-<%= city.replace(/\s+/g, '-').toLowerCase() %>" aria-expanded="false">
                    <strong><%= city %></strong>
                    <span class="float-end badge bg-secondary"><%= cityParticipants.length %> participant<%= cityParticipants.length !== 1 ? 's' : '' %></span>
                  </div>
                  <div class="collapse" id="city-<%= city.replace(/\s+/g, '-').toLowerCase() %>">
                    <div class="city-content">
                      <div class="table-responsive">
                        <table class="table table-sm table-striped mb-0">
                          <thead class="table-dark">
                            <tr>
                              <th>Name</th>
                              <th>Email</th>
                              <th>DOB</th>
                              <th>Role</th>
                              <th>Phone</th>
                              <th>State</th>
                              <th>Zip</th>
                              <th>School/Employer</th>
                              <th>Field</th>
                              <th>Donations</th>
                            </tr>
                          </thead>
                          <tbody>
                            <% cityParticipants.forEach(function(p) { %>
                              <tr class="participant-row" data-name="<%= (p.ParticipantFirstName + ' ' + p.ParticipantLastName).toLowerCase() %>" onclick="window.location.href='/displayParticipants?id=<%= p.ParticipantID %>';" style="cursor: pointer;">
                                <td><%= p.ParticipantFirstName %> <%= p.ParticipantLastName %></td>
                                <td><%= p.ParticipantEmail %></td>
                                <td><%= p.ParticipantDOB ? new Date(p.ParticipantDOB).toLocaleDateString() : '—' %></td>
                                <td><%= p.ParticipantRole || '—' %></td>
                                <td><%= p.ParticipantPhone || '—' %></td>
                                <td><%= p.ParticipantState || '—' %></td>
                                <td><%= p.ParticipantZip || '—' %></td>
                                <td><%= p.ParticipantSchoolOrEmployer || '—' %></td>
                                <td><%= p.ParticipantFieldOfInterest || '—' %></td>
                                <td>$<%= p.TotalDonations !== null ? p.TotalDonations : '0.00' %></td>
                              </tr>
                            <% }) %>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
              <% } %>
            <% }) %>
          </div>
        <% } else if (typeof participant !== 'undefined' && participant && participant.ParticipantID) { %>
          <div class="card p-4 mb-4">
            <h4><%= participant.ParticipantFirstName %> <%= participant.ParticipantLastName %> <small class="text-muted">(ID: <%= participant.ParticipantID %>)</small></h4>
            
            <!-- View Mode -->
            <div id="viewMode">
              <div class="row mt-3">
                <div class="col-md-6">
                  <p><span class="label">Email:</span> <%= participant.ParticipantEmail %></p>
                  <p><span class="label">Phone:</span> <%= participant.ParticipantPhone || '—' %></p>
                  <p><span class="label">DOB:</span> <%= participant.ParticipantDOB ? new Date(participant.ParticipantDOB).toLocaleDateString() : '—' %></p>
                  <p><span class="label">Role:</span> <%= participant.ParticipantRole || '—' %></p>
                </div>
                <div class="col-md-6">
                  <p><span class="label">City:</span> <%= participant.ParticipantCity || '—' %></p>
                  <p><span class="label">State:</span> <%= participant.ParticipantState || '—' %></p>
                  <p><span class="label">Zip:</span> <%= participant.ParticipantZip || '—' %></p>
                </div>
              </div>
              <hr />
              <p><span class="label">School / Employer:</span> <%= participant.ParticipantSchoolOrEmployer || '—' %></p>
              <p><span class="label">Field of Interest:</span> <%= participant.ParticipantFieldOfInterest || '—' %></p>
              <p><span class="label">Total Donations:</span> $<%= participant.TotalDonations !== null ? participant.TotalDonations : '0.00' %></p>
              
              <% if (typeof userLevel !== 'undefined' && userLevel === 'M') { %>
                <div class="mt-3">
                  <button onclick="toggleEditMode()" class="btn btn-primary me-2">Edit Participant</button>
                  <a href="/confirmDeleteParticipant?participantId=<%= participant.ParticipantID %>" class="btn btn-danger">Delete Participant</a>
                </div>
              <% } %>
            </div>

            <!-- Edit Mode -->
            <% if (typeof userLevel !== 'undefined' && userLevel === 'M') { %>
              <div id="editMode" style="display: none;">
                <form method="POST" action="/updateParticipant">
                  <input type="hidden" name="participantId" value="<%= participant.ParticipantID %>" />
                  <div class="row mt-3">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label class="form-label">First Name</label>
                        <input type="text" name="firstName" class="form-control" value="<%= participant.ParticipantFirstName || '' %>" required />
                      </div>
                      <div class="mb-3">
                        <label class="form-label">Last Name</label>
                        <input type="text" name="lastName" class="form-control" value="<%= participant.ParticipantLastName || '' %>" required />
                      </div>
                      <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" name="email" class="form-control" value="<%= participant.ParticipantEmail || '' %>" required />
                      </div>
                      <div class="mb-3">
                        <label class="form-label">Phone</label>
                        <input type="text" name="phone" class="form-control" value="<%= participant.ParticipantPhone || '' %>" />
                      </div>
                      <div class="mb-3">
                        <label class="form-label">Date of Birth</label>
                        <input type="date" name="dob" class="form-control" value="<%= participant.ParticipantDOB ? new Date(participant.ParticipantDOB).toISOString().split('T')[0] : '' %>" />
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label class="form-label">Role</label>
                        <input type="text" name="role" class="form-control" value="<%= participant.ParticipantRole || '' %>" />
                      </div>
                      <div class="mb-3">
                        <label class="form-label">City</label>
                        <input type="text" name="city" class="form-control" value="<%= participant.ParticipantCity || '' %>" />
                      </div>
                      <div class="mb-3">
                        <label class="form-label">State</label>
                        <input type="text" name="state" class="form-control" value="<%= participant.ParticipantState || '' %>" />
                      </div>
                      <div class="mb-3">
                        <label class="form-label">Zip Code</label>
                        <input type="text" name="zip" class="form-control" value="<%= participant.ParticipantZip || '' %>" />
                      </div>
                    </div>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">School / Employer</label>
                    <input type="text" name="schoolOrEmployer" class="form-control" value="<%= participant.ParticipantSchoolOrEmployer || '' %>" />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Field of Interest</label>
                    <input type="text" name="fieldOfInterest" class="form-control" value="<%= participant.ParticipantFieldOfInterest || '' %>" />
                  </div>
                  <div class="mt-3">
                    <button type="submit" class="btn btn-success me-2">Save Changes</button>
                    <button type="button" onclick="toggleEditMode()" class="btn btn-secondary">Cancel</button>
                  </div>
                </form>
              </div>
            <% } %>
          </div>

          <!-- Milestones Section -->
          <% if (typeof userLevel !== 'undefined' && userLevel === 'M' && typeof milestones !== 'undefined') { %>
            <div class="card p-4 mb-4">
              <h4>Milestones</h4>
              
              <!-- Add New Milestone -->
              <div class="border rounded p-3 mb-3">
                <h5>Add New Milestone</h5>
                <form method="POST" action="/addParticipantMilestone">
                  <input type="hidden" name="participantId" value="<%= participant.ParticipantID %>" />
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label class="form-label">Milestone Title</label>
                        <input type="text" name="milestoneTitle" class="form-control" required />
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="mb-3">
                        <label class="form-label">Date</label>
                        <input type="date" name="milestoneDate" class="form-control" required />
                      </div>
                    </div>
                    <div class="col-md-2">
                      <div class="mb-3">
                        <label class="form-label">&nbsp;</label>
                        <button type="submit" class="btn btn-primary w-100">Add</button>
                      </div>
                    </div>
                  </div>
                </form>
              </div>

              <!-- Existing Milestones -->
              <% if (milestones.length > 0) { %>
                <div class="table-responsive">
                  <table class="table table-striped">
                    <thead class="table-dark">
                      <tr>
                        <th>Title</th>
                        <th>Date</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% milestones.forEach(function(m) { %>
                        <tr>
                          <td>
                            <span class="milestone-view-<%= m.MilestoneID %>"><%= m.MilestoneTitle %></span>
                            <input type="text" class="form-control milestone-edit-<%= m.MilestoneID %>" value="<%= m.MilestoneTitle %>" style="display: none;" />
                          </td>
                          <td>
                            <span class="milestone-view-<%= m.MilestoneID %>"><%= m.MilestoneDate ? new Date(m.MilestoneDate).toLocaleDateString() : '—' %></span>
                            <input type="date" class="form-control milestone-edit-<%= m.MilestoneID %>" value="<%= m.MilestoneDate ? new Date(m.MilestoneDate).toISOString().split('T')[0] : '' %>" style="display: none;" />
                          </td>
                          <td>
                            <button onclick="editMilestone(<%= m.MilestoneID %>)" class="btn btn-sm btn-warning milestone-view-<%= m.MilestoneID %>">Edit</button>
                            <button onclick="saveMilestone(<%= m.MilestoneID %>, <%= participant.ParticipantID %>)" class="btn btn-sm btn-success milestone-edit-<%= m.MilestoneID %>" style="display: none;">Save</button>
                            <button onclick="cancelEditMilestone(<%= m.MilestoneID %>)" class="btn btn-sm btn-secondary milestone-edit-<%= m.MilestoneID %>" style="display: none;">Cancel</button>
                            <form method="POST" action="/deleteMilestone" style="display: inline;" onsubmit="return confirm('Delete this milestone?');">
                              <input type="hidden" name="milestoneId" value="<%= m.MilestoneID %>" />
                              <input type="hidden" name="participantId" value="<%= participant.ParticipantID %>" />
                              <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                            </form>
                          </td>
                        </tr>
                      <% }) %>
                    </tbody>
                  </table>
                </div>
              <% } else { %>
                <p class="text-muted">No milestones recorded for this participant.</p>
              <% } %>
            </div>
          <% } %>
        <% } else { %>
          <div class="alert alert-info">No participant information found for your account.</div>
        <% } %>

      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function toggleEditMode() {
      const viewMode = document.getElementById('viewMode');
      const editMode = document.getElementById('editMode');
      if (viewMode.style.display === 'none') {
        viewMode.style.display = 'block';
        editMode.style.display = 'none';
      } else {
        viewMode.style.display = 'none';
        editMode.style.display = 'block';
      }
    }

    function editMilestone(milestoneId) {
      const viewElements = document.querySelectorAll('.milestone-view-' + milestoneId);
      const editElements = document.querySelectorAll('.milestone-edit-' + milestoneId);
      viewElements.forEach(el => el.style.display = 'none');
      editElements.forEach(el => el.style.display = 'inline-block');
    }

    function cancelEditMilestone(milestoneId) {
      const viewElements = document.querySelectorAll('.milestone-view-' + milestoneId);
      const editElements = document.querySelectorAll('.milestone-edit-' + milestoneId);
      viewElements.forEach(el => el.style.display = 'inline-block');
      editElements.forEach(el => el.style.display = 'none');
    }

    function saveMilestone(milestoneId, participantId) {
      const titleInput = document.querySelector('.milestone-edit-' + milestoneId + '[type="text"]');
      const dateInput = document.querySelector('.milestone-edit-' + milestoneId + '[type="date"]');
      
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = '/editParticipantMilestone';
      
      const inputs = [
        { name: 'milestoneId', value: milestoneId },
        { name: 'participantId', value: participantId },
        { name: 'milestoneTitle', value: titleInput.value },
        { name: 'milestoneDate', value: dateInput.value }
      ];
      
      inputs.forEach(data => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = data.name;
        input.value = data.value;
        form.appendChild(input);
      });
      
      document.body.appendChild(form);
      form.submit();
    }

    function filterParticipants() {
      const input = document.getElementById('searchInput');
      const filter = input.value.toLowerCase();
      const rows = document.getElementsByClassName('participant-row');
      const cityGroups = document.getElementsByClassName('city-group');
      
      // Filter rows
      for (let i = 0; i < rows.length; i++) {
        const name = rows[i].getAttribute('data-name');
        if (name.indexOf(filter) > -1) {
          rows[i].style.display = '';
        } else {
          rows[i].style.display = 'none';
        }
      }
      
      // Show/hide city groups and auto-expand if searching
      for (let i = 0; i < cityGroups.length; i++) {
        const cityGroup = cityGroups[i];
        const visibleRows = Array.from(cityGroup.querySelectorAll('.participant-row')).filter(row => row.style.display !== 'none');
        
        if (visibleRows.length > 0) {
          cityGroup.style.display = '';
          
          // Auto-expand groups when searching
          if (filter.length > 0) {
            const collapseDiv = cityGroup.querySelector('.collapse');
            if (collapseDiv && !collapseDiv.classList.contains('show')) {
              const bsCollapse = new bootstrap.Collapse(collapseDiv, { toggle: true });
            }
          }
        } else {
          cityGroup.style.display = 'none';
        }
      }
    }
  </script>
</body>
</html>
