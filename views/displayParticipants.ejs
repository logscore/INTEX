<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Participants</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #ffd8d1; font-family: Arial, sans-serif; padding-top: 90px; }
    .card { border-radius: 12px; }
    .label { font-weight: 600; color: #444; }
    .city-group { margin-bottom: 20px; }
    .city-header { cursor: pointer; padding: 12px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #e45858; }
    .city-header:hover { background: #e9ecef; }
    .city-content { padding: 12px; background: #ffffff; border: 1px solid #dee2e6; border-top: none; border-radius: 0 0 8px 8px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-10">
        <div class="card p-4 mb-4">
          <div class="d-flex justify-content-between align-items-center">
            <h2>Participants</h2>
            <% if (typeof groupedParticipants !== 'undefined' && groupedParticipants) { %>
              <a href="/userDashboard" class="btn btn-white btn-sm">Return to Dashboard</a>
            <% } else if (typeof participant !== 'undefined' && participant && participant.ParticipantID) { %>
              <a href="/displayParticipants" class="btn btn-white btn-sm">Back</a>
            <% } %>
          </div>
        </div>

        <% if (typeof groupedParticipants !== 'undefined' && groupedParticipants) { %>
          <div class="card p-3 mb-4">
            <h4>All Participants</h4>
            <div class="mb-3">
              <input type="text" id="searchInput" class="form-control" placeholder="Search by participant name..." onkeyup="filterParticipants()">
            </div>
            <% Object.entries(groupedParticipants).forEach(function([city, cityParticipants]) { %>
              <% if (cityParticipants.length > 0) { %>
                <div class="city-group">
                  <div class="city-header" data-bs-toggle="collapse" data-bs-target="#city-<%= city.replace(/\s+/g, '-').toLowerCase() %>" aria-expanded="false">
                    <strong><%= city %></strong>
                    <span class="float-end badge bg-secondary"><%= cityParticipants.length %> participant<%= cityParticipants.length !== 1 ? 's' : '' %></span>
                  </div>
                  <div class="collapse" id="city-<%= city.replace(/\s+/g, '-').toLowerCase() %>">
                    <div class="city-content">
                      <div class="table-responsive">
                        <table class="table table-sm table-striped mb-0">
                          <thead class="table-dark">
                            <tr>
                              <th>Name</th>
                              <th>Email</th>
                              <th>DOB</th>
                              <th>Role</th>
                              <th>Phone</th>
                              <th>State</th>
                              <th>Zip</th>
                              <th>School/Employer</th>
                              <th>Field</th>
                              <th>Donations</th>
                            </tr>
                          </thead>
                          <tbody>
                            <% cityParticipants.forEach(function(p) { %>
                              <tr class="participant-row" data-name="<%= (p.ParticipantFirstName + ' ' + p.ParticipantLastName).toLowerCase() %>" onclick="window.location.href='/displayParticipants?id=<%= p.ParticipantID %>';" style="cursor: pointer;">
                                <td><%= p.ParticipantFirstName %> <%= p.ParticipantLastName %></td>
                                <td><%= p.ParticipantEmail %></td>
                                <td><%= p.ParticipantDOB ? new Date(p.ParticipantDOB).toLocaleDateString() : '—' %></td>
                                <td><%= p.ParticipantRole || '—' %></td>
                                <td><%= p.ParticipantPhone || '—' %></td>
                                <td><%= p.ParticipantState || '—' %></td>
                                <td><%= p.ParticipantZip || '—' %></td>
                                <td><%= p.ParticipantSchoolOrEmployer || '—' %></td>
                                <td><%= p.ParticipantFieldOfInterest || '—' %></td>
                                <td>$<%= p.TotalDonations !== null ? p.TotalDonations : '0.00' %></td>
                              </tr>
                            <% }) %>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
              <% } %>
            <% }) %>
          </div>
        <% } else if (typeof participant !== 'undefined' && participant && participant.ParticipantID) { %>
          <div class="card p-4 mb-4">
            <h4><%= participant.ParticipantFirstName %> <%= participant.ParticipantLastName %> <small class="text-muted">(ID: <%= participant.ParticipantID %>)</small></h4>
            <div class="row mt-3">
              <div class="col-md-6">
                <p><span class="label">Email:</span> <%= participant.ParticipantEmail %></p>
                <p><span class="label">Phone:</span> <%= participant.ParticipantPhone || '—' %></p>
                <p><span class="label">DOB:</span> <%= participant.ParticipantDOB ? new Date(participant.ParticipantDOB).toLocaleDateString() : '—' %></p>
                <p><span class="label">Role:</span> <%= participant.ParticipantRole || '—' %></p>
              </div>
              <div class="col-md-6">
                <p><span class="label">City:</span> <%= participant.ParticipantCity || '—' %></p>
                <p><span class="label">State:</span> <%= participant.ParticipantState || '—' %></p>
                <p><span class="label">Zip:</span> <%= participant.ParticipantZip || '—' %></p>
              </div>
            </div>

            <hr />
            <p><span class="label">School / Employer:</span> <%= participant.ParticipantSchoolOrEmployer || '—' %></p>
            <p><span class="label">Field of Interest:</span> <%= participant.ParticipantFieldOfInterest || '—' %></p>
            <p><span class="label">Total Donations:</span> $<%= participant.TotalDonations !== null ? participant.TotalDonations : '0.00' %></p>
            <% if (typeof userLevel !== 'undefined' && userLevel === 'M') { %>
              <a href="/confirmDeleteParticipant?participantId=<%= participant.ParticipantID %>" class="btn btn-danger">Delete Participant</a>
            <% } %>
          </div>
        <% } else { %>
          <div class="alert alert-info">No participant information found for your account.</div>
        <% } %>

      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function filterParticipants() {
      const input = document.getElementById('searchInput');
      const filter = input.value.toLowerCase();
      const rows = document.getElementsByClassName('participant-row');
      const cityGroups = document.getElementsByClassName('city-group');
      
      // Filter rows
      for (let i = 0; i < rows.length; i++) {
        const name = rows[i].getAttribute('data-name');
        if (name.indexOf(filter) > -1) {
          rows[i].style.display = '';
        } else {
          rows[i].style.display = 'none';
        }
      }
      
      // Show/hide city groups and auto-expand if searching
      for (let i = 0; i < cityGroups.length; i++) {
        const cityGroup = cityGroups[i];
        const visibleRows = Array.from(cityGroup.querySelectorAll('.participant-row')).filter(row => row.style.display !== 'none');
        
        if (visibleRows.length > 0) {
          cityGroup.style.display = '';
          
          // Auto-expand groups when searching
          if (filter.length > 0) {
            const collapseDiv = cityGroup.querySelector('.collapse');
            if (collapseDiv && !collapseDiv.classList.contains('show')) {
              const bsCollapse = new bootstrap.Collapse(collapseDiv, { toggle: true });
            }
          }
        } else {
          cityGroup.style.display = 'none';
        }
      }
    }
  </script>
</body>
</html>
